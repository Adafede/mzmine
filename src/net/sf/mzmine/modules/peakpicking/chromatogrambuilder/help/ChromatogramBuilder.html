<html>
	<head>
		<title>Chromatogram builder</title>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<link rel="stylesheet" type="text/css" href="/net/sf/mzmine/desktop/helpsystem/HelpStyles.css">
    </head>

<body>

<h1>Chromatogram builder</h1>

<h2>Description</h2>

<p>
The Chromatogram builder is the main module for peak detection in MZmine 2.
The peak detection process uses three steps:
Mass detection, Filtering and Chromatogram construction. 
The motivation to divide the process in several steps is to allow the users to optimize each step according to the characteristics of their data.
</p>

<h2>Mass detection</h2>

In the Mass detection step,  

<p style="margin-left: 30px;" align="justify"; >
The first step is identify the representative data point of each peak in spectrum domain.
 This is achieved by different approaches, depending of raw data characteristics (resolution,
 mass, intensity and peak shape).<br><br><i>Mass detectors</i><br><br>

<h3>Centroid mass detector</h3>


This mass detector search for each data point in the current spectrum. Due each data used to represent mass spectral peaks, the weighted center of mass and the intensity, every one of this data point is considered as a mass spectrum peak.

This detector use a single parameter "noise level". This value sets the minimum intensity level for a centroided data point must have to be consider as part of a possible peak.



<h3>Exact mass detector</h3>


This mass detector search for all local maximum data points in the current spectrum. After that it sort all of them in descending order. The next step is calculate the exact mass for each mass spectrum peak and remove lateral peaks, starting with the biggest intensity data point and so on.

First the method locates the closest data points to the FWHM (P1, P2, P3, P4). With these four points is possible to calculate two points (cP1, cP2) that define the width of the peak and the exact mass (the center of the width is consider as exact mass).

This detector requires the next three parameters:
"Noise level"
This value sets the minimum intensity level that a data point must have to be consider part of a possible peak.
"Mass resolution"
This value is defined as m/dm where m designates the mass and dm the peak width. A specific m/z value and the relationship of full width at half maximum (FWHM) is possible to calculate this value. Mass resolution is usually a large number (up to 10,000 for MS) and is used as “performance” parameter in many mass spectrometers.

"Peak Model function"
The raw data obtained from a FTMS Mass Spectrometer usually contains a lot of small shoulder peaks (FTMS shoulder peaks). This data points can be casted aside of the peak detection process. In order to reach this, a peak model (shape) is used to determine which of these data points are shoulder peaks and which not. 




<h3>Local maxima mass detector</h3>


This mass detector search for all local maximum data points in the current spectrum and discard those that do not have the minimal height (intensity) defined by noise level parameter. The group of data points where the local maximum data point was found is used to form the mass spectrum peak.
This detector use a single parameter "noise level". This value sets the minimum intensity level for a each local maximum data point must have to be consider as part of a possible peak.



<h3>Recursive threshold mass detector</h3>


This mass detector search for the local maximum data points in the current spectrum that cover the characteristics stipulated in its parameters. The method looks for local maximum in a group of data points and is executed in recursive way. If this group has the right width (m/z difference between the first and last data point) and height (local maximum intensity) is consider as a mass spectrum peak. The minimum length and intensity are defined by the parameters. 
Each detected mass spectrum peak is defined by the group of data points where the local maximum was found, and the mass and intensity of the local maximum data point.

This detector requires the next three parameters:

"Noise level"
This value sets the minimum intensity level that a data point must have to be consider part of a possible mass spectrum peak.

"Min m/z peak width"
This value is minimum acceptable m/z difference between the first and last data point (width). This parameter is used to determine when stop the recursive search and to discard too small mass spectrum peaks. 

"Max m/z peak width"
This value is maximum acceptable m/z difference between the first and last data point (width). This parameter is used to determine when stop the recursive search.


<h3>Wavelet transform mass detector</h3>
<p style="margin-left: 30px;" align="justify"; >
This mass detector uses the Mexican Hat wavelet, that is a continuous wavelet transform
 (CMT). The search of mass spectrum peaks is executed in three steps. First converts the 
 original intensity of data points into wavelet domain. Next look for all local maximums 
 in the calculated wavelet. And finally sets a mass spectrum peak in the same point where
 the wavelet has a local maximum.  
<br><br>
The mass spectrum peak is formed with the selected data point (mass and intensity) using 
the wavelet and all surrounding data points. These weightings determine the relative importance
 of each data point mass on the average. The data points used in the calculation of 
 exact mass are considered part of the mass spectrum peak. 
 <br><br>
This mass detector is recommended for raw data with low resolution. 
</p>

<h2 style="margin-left: 20px;">Mathematical model</h2>

<p style="margin-left: 30px;" align="justify"; >
In mathematics and numerical analysis, the Mexican hat wavelet is the normalized second derivative
 of a Gaussian function.
</p>

<table style="margin-left: 30px; margin-right: auto;">

<tr></tr>
<tr></tr>
<tr>
	<td>
	<img src="WaveletFormula.png">
	</td>
</tr>
</table>

<p style="margin-left: 30px;" align="justify"; >
The parameter t is the intensity of each data point in the curve,
 and sigma corresponds to the standard deviation.<br>
</p>

<table style="margin-left: 30px; margin-right: auto;">
<tr></tr>
<tr></tr>
<tr>
<td>
	<td>
	<img src="Wavelet_Mex_Hat.png">
	</td>
	<td>
	<img src="Wavelet_calculated_form.jpg">
	</td>
</td>
</tr>
</table>

<p style="margin-left: 30px;" align="justify"; >
To make easier the process of wavelet calculation the original function 
is turned into two parts, where <i>Wc</i> is the wavelet coeefient and <i>y</i>
is the intensity of the wavelet on certain point. In the first formula "t" is the
<i>"Wavelet window size(%)"</i> parameter.
</p>

<table style="margin-left: 30px; margin-right: auto;">

<tr></tr>
<tr></tr>
<tr>
	<td>
	<img src="Wavelet_coefficients_calculation.jpg">
	</td>
</tr>
<tr></tr>
<tr>
	<td>
	<img src="Wavelet_intensities_calculation.jpg">
	</td>
</tr>
</table>

<p style="margin-left: 30px;" align="justify"; >
The limits where is evaluated the Mexican Hat wavelet are from -5 until 5 (ESL,ESR)
 and the incremental step used in this range is result of divide the range from ESL 
 until ESR by 60000. The number of coeffients used to calculated the wavelet intensity 
 depends on the <i>"Scale level"</i> parameter.
</p>

<h2 style="margin-left: 20px;">Parameters</h2>

<p style="margin-left: 30px;" align="justify"; >
This detector requires the next three parameters:<br><br>
<i>"Noise level"</i><br>
This value sets the minimum intensity level that a data point must
 have to be consider part of a possible peak.<br><br>
<i>"Scale level"</i><br>
This value is the scale factor that either dilates or compresses the wavelet signal. 
When the scale factor is relatively low, the signal is more contracted which in turn 
results in a more detailed resulting graph and as a consequence more noisy peaks are detected.
 On the other hand, when the scale factor is high, the signal is stretched out which means that
 the resulting graph will be presented in less detail resulting in a smoothed signal.<br><br>
<i>"Wavelet window size(%)"</i><br>
This value is the size of the window used to calculated the wavelet signal. 
When the size of the window is small makes more noisy peaks could be detected.
 On the other hand, when the size of the window is complete is possible to avoid the undesired
 peaks, depending on the raw data to process this parameter is manipulated by the user.<br><br>
 
 <table style="margin-left: 30px; margin-right: auto;">

<tr></tr>
<tr></tr>
<tr>
<td>
	<td>Wavelet window size at 10%<br>
	<img src="Wavelet_window_size10.jpg" border="2">
	</td>
	<td>Wavelet window size at 100%<br>
	<img src="Wavelet_window_size100.jpg"  border="2">
	</td>
<td>
</tr>
</tr>
</table>
</p>

<table style="margin-left: 30px; margin-right: auto;">

<tr></tr>
<tr></tr>
<tr>
	<td>Parameter setup dialog<br><br>
	<img src="Wavelet_mass_detector_set.jpg">
	</td>
</tr>
<tr></tr>
<tr></tr>
<tr>
	<td>
	Spectrum plot showing detected peaks<br><br>
	<img src="Wavelet_mass_detector_preview.jpg">
	</p>
	</td>
</tr>

</table>



<h2>Filtering</h2>

<p>
Filtering is optional operation
</p>

<h3>FTMS Shoulder peaks filter</h3>



<h2>Chromatogram construction</h2>

<p style="margin-left: 30px;" align="justify"; >
After mass detection is finished in one spectrum the second step take each one of the detected 
masses and try to find the most related chromatogram. If it is not possible to relate a mass data 
point with any chromatogram, a new chromatogram is initialized with this mass. The factor to 
establish the relationship between a chromatogram and a mass datapoint depends on the mass (m/z) 
and intensity.<br><br><i>Chromatogram builders</i><br><br>

<li><a href="../xicconstruction/highestdatapoint/help/HighIntensityConnector.html">Highest datapoint connector</a></li>

This chromatogram builder connects the received mass spectrum peak across the retention time to one chromatogram based in a match score. This match score is set using as a criteria the next highest data point within a m/z range. This builder determines which mass spectrum peaks are within the m/z range having as a central point the last mass peak added to the current chromatogram.

This detector use a single parameter "noise level". This value sets the minimum intensity level for a centroided data point must have to be consider as part of a possible peak.
Parameter setup dialog

</p>

</body>
</html>
